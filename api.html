<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
 
    <?!= include("css") ?>
  </head>
  <body>
    <div id="app">
        <div class="row">
            <div class="col s0 xl1"></div>
            <div class="col s12 xl10 card">
               <nav>
                    <div class="nav-wrapper">
                        <a href="<?!= getPageUrl() ?>" class="brand-logo">
                            <i class="material-icons">home</i>Home</a>
                        <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
                        <ul class="right hide-on-med-and-down">
                            <li><a href="<?!= getPageUrl() ?>">
                                <i class="material-icons left">send</i>Log in</a></li>
                        </ul>
                    </div>
                </nav>
                
                <ul class="sidenav" id="mobile-demo">
                    <li><a href="<?!= getPageUrl() ?>">
                        <i class="material-icons left">send</i>Log in</a></li>
                </ul>
                
                <? if (data.status !== 'success'){ ?>
                    <div class="card-content">
                      <h4 class="red-text"><b><?=data.status?></b></h4>
                      <p class="red-text"><?= data.message ?></p>
                    </div>
                <?}else{?>
                   <div class="card-content" id="result">
                       <div class="input-field">
                           <h4 class="teal-text" id="approval" 
                               email='<?= data.approval.assignTo ?>' 
                               uuid='<?=data.approval.uuid?>' ><b>Apprvoal</b></h4>
                       </div>
                       
                       <table>
                           <tbody>
                               <tr><td>Title</td><td><?= data.approval.title ?></td></tr>
                               <tr><td>Description</td><td><?= data.approval.description ?></td></tr>
                               <tr><td>Created by</td><td><?= data.approval.createdBy ?></td></tr>
                               <tr><td>Files</td>
                                   <td><?for (let i = 0; i < data.approval.files.length; i ++){?>
                                       <?!= data.approval.files[i] ?><?}?></td>
                               </tr>
                               <tr><td>Comments</td><td><?!= data.approval.comments ?></td></tr>
                           </tbody>
                       </table>

                       <div class="input-field">
                           <h4 class="teal-text"><b>Action</b></h4>
                       </div>
                       
                       <div class="input-field">
                            <select>
                                <option value="" disabled selected>Choose your action</option>
                                <option value="approved">Approve</option>
                                <option value="rejected">Reject</option>
                                <option value="pending">Reassign</option>
                            </select>
                            <label>Action</label>
                        </div>
                        
                        <div id='assing-to-div' class="input-field" style="display:none;">
                           <input id="assign-to" type="text">
                           <label for="assign-to">Reassign to</label>
                        </div>
                        
                        <div class="input-field">
                           <input id="your-comments" type="text">
                           <label for="your-comments">Your comments</label>
                        </div>
                        
                        <div class="input-field">
                            <button id="submit" class="btn waves-effect waves-light" type="submit" name="action">Submit
                                <i class="material-icons right">send</i>
                            </button>
                        </div>
                        
                        <div class="input-field" id="message">
                        </div>
                   </div>
                   <?}?>
               <?!= include("html_footer") ?> 
            </div>
            <div class="col s0 xl1"></div>
        </div>
    </div>
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        if(1>0){
          document.getElementByClassName("white-text").innerHTML = data.getUidLine;
        }
        document.addEventListener('DOMContentLoaded', function() {
            var elems = document.querySelectorAll('select')
            var instances = M.FormSelect.init(elems)
            
            let actionSelect = document.querySelector("select")
            let div = document.querySelector("#assing-to-div")
            let commentsInput = document.querySelector("#your-comments")
            let assginToInput = document.querySelector("#assign-to")
            let submit = document.querySelector("#submit")
            let approval = document.querySelector("#approval")
            let result = document.querySelector("#result")
            let message = document.querySelector("#message")
            
            
            if (actionSelect){
                actionSelect.addEventListener('change', e=>{
                    
                    if (e.target.value === 'pending'){
                        div.style.display = 'block'
                    }else{
                        div.style.display = 'none'
                    }
                })
            }
            
            if (submit){
                submit.addEventListener('click', ()=>{
                    let uuid = approval.getAttribute("uuid")
                    let email = approval.getAttribute("email")
                    let status = actionSelect.value
                    let assignTo = assginToInput.value
                    let comments = commentsInput.value
                    comments = `[${email}]-[${status}]-[${comments}]`
                    
                    if (status){
                        if (status === 'pending'){
                            if (assignTo.indexOf("@") > 0){
                                submit.disabled = true
                                message.innerHTML = `<p class="teal-text">submitting...<\/p>`
                                // reassign
                                google.script.run
                                    .withSuccessHandler(approval=>{
                                        
                                        result.innerHTML = `<h4 class="teal-text">${approval.status}<\/h4><p>${approval.comments}<\/p>`
                                        submit.disabled = false
                                    })
                                    .withFailureHandler(error=>{
                                        message.innerHTML = `<p class="red-text">${error.message}<\/p>`
                                    })
                                    .changeApprovalStatus(assignTo, uuid, status, comments)
                            }else{
                                message.innerHTML = `<p class="red-text">Invalid assign to email address.<\/p>`
                            }
                        }else{
                            submit.disabled = true
                            message.innerHTML = `<p class="teal-text">submitting...<\/p>`
                            google.script.run
                                .withSuccessHandler(approval=>{
                                    result.innerHTML = `<h4 class="teal-text">${approval.status}<\/h4><p>${approval.comments}<\/p>`
                                    submit.disabled = false
                                })
                                .withFailureHandler(error=>{
                                    message.innerHTML = `<p class="red-text">${error.message}<\/p>`
                                })
                                .changeApprovalStatus(null, uuid, status, comments)
                            
                        }
                    }else{
                        message.innerHTML = `<p class="red-text">Chosse an action, please!<\/p>`
                    }
                    
                })
            }
            
        })
    </script>
  </body>
</html>





